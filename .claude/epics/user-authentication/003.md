---
name: Core Authentication API Endpoints
status: open
created: 2026-01-06T08:26:55Z
updated: 2026-01-06T08:26:55Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002]
parallel: false
conflicts_with: []
---

# Task: Core Authentication API Endpoints

## Description

Implement all authentication API endpoints including registration, login, email verification, OAuth callbacks, and JWT middleware. This covers the primary user authentication flows for both email/password and OAuth login.

## Acceptance Criteria

- [ ] POST /api/auth/register endpoint (email/password registration)
- [ ] POST /api/auth/verify-email endpoint (token verification)
- [ ] POST /api/auth/resend-verification endpoint (resend verification email)
- [ ] POST /api/auth/login endpoint (email/password login)
- [ ] GET /api/auth/oauth/google endpoint (OAuth initiation)
- [ ] GET /api/auth/oauth/google/callback endpoint
- [ ] GET /api/auth/oauth/microsoft endpoint
- [ ] GET /api/auth/oauth/microsoft/callback endpoint
- [ ] GET /api/auth/me endpoint (get current user)
- [ ] JWT validation middleware implemented
- [ ] All endpoints return proper status codes and error messages
- [ ] Response time < 2 seconds for login, < 3 seconds for registration

## Technical Details

**API Endpoints to Implement:**

**1. POST /api/auth/register**

- Validates email format and uniqueness
- Validates password complexity (uses Better Auth rules)
- Hashes password (bcrypt cost 12)
- Creates user record (status: pending_verification)
- Generates email verification token
- Triggers verification email
- Returns: `{ message: "Check your email to verify account" }`

**2. POST /api/auth/verify-email**

- Query param: token
- Validates token exists and not expired
- Updates user: email_verified=true, status=active, trial_expires_at=now+14days
- Marks token as used
- Returns: `{ success: true, redirect: "/login" }`

**3. POST /api/auth/login**

- Body: `{ email, password, remember_me }`
- Validates user exists and email verified
- Checks account not locked or deactivated
- Verifies password hash
- Checks failed_login_count < 5
- Generates JWT token (3 days or 30 days if remember_me)
- Updates last_login_at and last_login_ip
- Resets failed_login_count to 0
- Logs login_success event
- Returns: `{ token, user: { id, email, full_name, subscription_tier } }`

**4. OAuth Endpoints**

- Google/Microsoft OAuth initiation redirects to provider
- Callback endpoints exchange code for access token
- Fetch user profile from provider
- Check if user exists by email
- If new: create user (email_verified=true, status=active)
- If existing: link OAuth provider to account
- Generate JWT token
- Redirect to dashboard with token

**5. GET /api/auth/me**

- Requires JWT in Authorization header
- Returns current user data from token
- Returns: `{ user: { id, email, full_name, subscription_tier, trial_expires_at } }`

**JWT Middleware:**

- Extracts token from `Authorization: Bearer <token>` header
- Verifies signature and expiration
- Validates user exists and is active
- Attaches user to request context
- Returns 401 if invalid/expired

**Files to Create:**

- `routes/auth.ts` - All authentication routes
- `controllers/auth.controller.ts` - Route handlers
- `middleware/jwt.ts` - JWT validation middleware
- `services/auth.service.ts` - Authentication business logic
- `validators/auth.validator.ts` - Input validation schemas

**Error Handling:**

- 400 Bad Request: Invalid input
- 401 Unauthorized: Invalid credentials, unverified email
- 403 Forbidden: Account locked or deactivated
- 429 Too Many Requests: Rate limit exceeded
- 500 Internal Server Error: Server errors

## Dependencies

- [ ] Task 001 completed (database schema)
- [ ] Task 002 completed (Better Auth configured)
- [ ] Email service configured for verification emails

## Effort Estimate

- Size: L
- Hours: 16-20 hours
- Parallel: false (depends on Better Auth setup)

## Definition of Done

- [ ] All 9 endpoints implemented and tested
- [ ] JWT middleware working correctly
- [ ] OAuth flows tested with Google and Microsoft
- [ ] Email verification flow working end-to-end
- [ ] All error cases handled with proper status codes
- [ ] Input validation working
- [ ] Response times meet performance requirements
- [ ] Unit tests written for all endpoints
- [ ] Integration tests for complete flows
- [ ] API documentation updated
- [ ] Code reviewed and merged
