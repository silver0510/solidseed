---
name: Password Management and Account Security
status: open
created: 2026-01-06T08:26:55Z
updated: 2026-01-06T08:26:55Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002]
parallel: true
conflicts_with: [003]
---

# Task: Password Management and Account Security

## Description

Implement password reset flow, password change for authenticated users, account lockout logic after failed login attempts, and authentication logging. This task covers all security features related to password management and account protection.

## Acceptance Criteria

- [ ] POST /api/auth/forgot-password endpoint (request password reset)
- [ ] POST /api/auth/reset-password endpoint (complete password reset)
- [ ] POST /api/auth/change-password endpoint (authenticated password change)
- [ ] Account lockout logic implemented (5 failed attempts â†’ 30 min lock)
- [ ] Security alert emails sent on lockout and password change
- [ ] Authentication logging to auth_logs table
- [ ] Background job for purging logs older than 7 days
- [ ] Rate limiting enforced (3 password reset requests per hour per email)

## Technical Details

**API Endpoints:**

**1. POST /api/auth/forgot-password**

- Body: `{ email }`
- Rate limit: 3 requests per hour per email
- Generates cryptographically random password reset token
- Stores token in password_resets table (expires in 1 hour)
- Sends password reset email
- Returns generic message (security): `{ message: "If account exists, reset link sent" }`

**2. POST /api/auth/reset-password**

- Body: `{ token, new_password }`
- Validates token exists and not expired
- Validates new password complexity
- Updates password hash in users table
- Marks token as used in password_resets table
- Invalidates all existing JWT sessions (user must re-login)
- Sends "Password changed" confirmation email
- Logs password_reset event
- Returns: `{ success: true }`

**3. POST /api/auth/change-password**

- Headers: `Authorization: Bearer <token>` (authenticated)
- Body: `{ current_password, new_password }`
- Validates current password matches
- Validates new password complexity
- Updates password hash
- Sends "Password changed" confirmation email
- Maintains current JWT session (no forced logout)
- Returns: `{ success: true }`

**Account Lockout Logic:**

- Increment failed_login_count on failed password verification
- When count reaches 5:
  - Set locked_until = now + 30 minutes
  - Send security alert email
  - Log lockout event
- On successful login: reset failed_login_count to 0
- Auto-unlock after 30 minutes (locked_until expires)

**Authentication Logging:**

- Log all auth events to auth_logs table
- Events: login_success, login_fail, logout, password_reset, lockout
- Capture: user_id (nullable for failed attempts), event_type, ip_address, user_agent, created_at
- Background job: purge records older than 7 days (runs daily)

**Security Email Templates:**

1. Password Reset Request - includes reset link, expires in 1 hour
2. Password Changed Confirmation - confirms password was changed
3. Account Lockout Alert - warns of multiple failed login attempts, includes reset link

**Files to Create/Modify:**

- `routes/auth.ts` - Add password management routes
- `controllers/password.controller.ts` - Password management handlers
- `services/password.service.ts` - Password reset logic
- `services/security.service.ts` - Lockout and logging logic
- `jobs/purge-auth-logs.job.ts` - Background job for log cleanup
- `templates/emails/password-reset.html`
- `templates/emails/password-changed.html`
- `templates/emails/account-lockout.html`

**Rate Limiting Implementation:**

- Use Redis or in-memory store
- Key: `ratelimit:password-reset:{email}`
- TTL: 1 hour
- Max: 3 requests

## Dependencies

- [ ] Task 001 completed (database schema)
- [ ] Task 002 completed (Better Auth configured)
- [ ] Email service configured
- [ ] Background job scheduler set up (cron or similar)

## Effort Estimate

- Size: L
- Hours: 14-18 hours
- Parallel: true (can work alongside Task 003 if different developers)

## Definition of Done

- [ ] All password management endpoints implemented
- [ ] Account lockout working after 5 failed attempts
- [ ] Security alert emails sending
- [ ] Authentication events logged to database
- [ ] Log purging job tested and scheduled
- [ ] Rate limiting verified for password reset
- [ ] All password reset flows tested end-to-end
- [ ] Security email templates created and tested
- [ ] Unit tests written for lockout and logging logic
- [ ] Integration tests for password reset flow
- [ ] Code reviewed and merged
