---
name: Database Schema and Migrations Setup
status: open
created: 2026-01-06T08:26:55Z
updated: 2026-01-06T08:58:07Z
github: [Will be updated when synced to GitHub]
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Database Schema and Migrations Setup

## Description

Create the complete database schema for the authentication system using Supabase PostgreSQL. Includes 5 tables (users, oauth_providers, password_resets, email_verifications, auth_logs) with all necessary fields, indexes, and constraints. Set up Supabase project, database migrations using Supabase CLI, and connection pooling.

## Acceptance Criteria

- [ ] Supabase project created and configured
- [ ] Supabase CLI initialized locally
- [ ] Users table created with 15 fields (id, email, password_hash, full_name, email_verified, email_verified_at, account_status, subscription_tier, trial_expires_at, failed_login_count, locked_until, last_login_at, last_login_ip, created_at, updated_at)
- [ ] OAuth providers table created with provider and provider_id fields
- [ ] Password resets table created with token expiration (1 hour)
- [ ] Email verifications table created with token expiration (24 hours)
- [ ] Auth logs table created with event tracking fields
- [ ] All tables have proper indexes (email unique, composite indexes for performance)
- [ ] Foreign key constraints established
- [ ] Migration scripts are reversible (Supabase CLI migrations)
- [ ] Database connection pooling configured via Supabase
- [ ] Migrations tested successfully with `supabase db push`
- [ ] Database accessible and verified via Supabase Studio

## Technical Details

**Tables to Create:**

1. **users**
   - Primary key: id (UUID)
   - Unique: email
   - Indexes: account_status, subscription_tier, email_verified
   - Default values: email_verified=false, account_status='pending', subscription_tier='trial', failed_login_count=0

2. **oauth_providers**
   - Composite unique: (provider, provider_id)
   - Foreign key: user_id → users.id
   - Index: user_id

3. **password_resets**
   - Unique: token
   - Foreign key: user_id → users.id
   - Indexes: user_id, expires_at
   - Auto-purge logic for expired tokens

4. **email_verifications**
   - Unique: token
   - Foreign key: user_id → users.id
   - Index: user_id

5. **auth_logs**
   - Index: user_id, created_at, event_type
   - Retention: 7 days (auto-purge)

**Supabase Setup:**

1. **Create Supabase Project:**

   ```bash
   # Create project at https://app.supabase.com
   # Note project URL and API keys
   # Copy database connection string from Settings > Database
   ```

2. **Initialize Supabase Locally:**

   ```bash
   # Install Supabase CLI
   npm install -g supabase

   # Initialize Supabase in project
   supabase init

   # Link to remote project
   supabase link --project-ref your-project-ref
   ```

3. **Environment Variables:**
   ```bash
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_ANON_KEY=your-anon-key
   SUPABASE_DATABASE_URL=postgresql://postgres:[password]@db.your-project.supabase.co:5432/postgres
   ```

**Migration Framework (Supabase CLI):**

- Use Supabase CLI for all database migrations
- Each table in separate migration file for clarity
- SQL-based migrations with automatic rollback support
- Migrations applied with `supabase db push` or via Supabase Studio

**Files to Create:**

- `supabase/migrations/20260106000001_create_users_table.sql`
- `supabase/migrations/20260106000002_create_oauth_providers_table.sql`
- `supabase/migrations/20260106000003_create_password_resets_table.sql`
- `supabase/migrations/20260106000004_create_email_verifications_table.sql`
- `supabase/migrations/20260106000005_create_auth_logs_table.sql`
- `config/database.js` - Supabase connection configuration

## Dependencies

- [ ] Supabase account created (free tier available)
- [ ] Supabase project created at https://app.supabase.com
- [ ] Supabase CLI installed (`npm install -g supabase`)
- [ ] Database credentials available in environment (URL, API keys, connection string)
- [ ] Node.js environment set up for Better Auth integration

## Effort Estimate

- Size: M
- Hours: 8-12 hours
- Parallel: false (foundational - must complete first)

## Definition of Done

- [ ] Supabase project created and configured
- [ ] Supabase CLI initialized and linked to project
- [ ] All 5 tables created with correct schema
- [ ] Indexes created for performance optimization
- [ ] Foreign key relationships established
- [ ] Migrations tested successfully with `supabase db push`
- [ ] Migration scripts committed to repository (`supabase/migrations/`)
- [ ] Database connection pooling verified working via Supabase
- [ ] Database schema visible and correct in Supabase Studio
- [ ] Environment variables documented and configured
- [ ] Connection from application to Supabase verified
- [ ] Documentation added for schema structure and Supabase setup
- [ ] Peer review completed
