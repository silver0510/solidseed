---
name: Session Management and Logout
status: open
created: 2026-01-06T08:26:55Z
updated: 2026-01-06T08:26:55Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: true
conflicts_with: []
---

# Task: Session Management and Logout

## Description

Implement session lifecycle management including "remember me" functionality, logout endpoint, session validation, and session expiration handling. Ensure JWT tokens work correctly with different expiration times and handle edge cases.

## Acceptance Criteria

- [ ] "Remember me" functionality extends JWT token to 30 days
- [ ] Default JWT token expiration is 3 days
- [ ] POST /api/auth/logout endpoint implemented
- [ ] Logout clears client-side token and logs event
- [ ] Session validation checks token expiration and user status
- [ ] Expired tokens return 401 with clear error message
- [ ] Deactivated users cannot authenticate with valid token
- [ ] Subscription tier changes reflected in session validation
- [ ] Session maintains across browser restarts when remember me enabled

## Technical Details

**Remember Me Implementation:**

- Login endpoint accepts `remember_me` boolean parameter
- If true: set JWT expiration to 30 days
- If false or not provided: set JWT expiration to 3 days
- Frontend stores token in localStorage (persists across restarts)

**Logout Endpoint:**

```typescript
POST /api/auth/logout
Headers: Authorization: Bearer <token>
Body: {}

Response:
{
  success: true,
  message: "Logged out successfully"
}

Actions:
1. Extract user_id from JWT token
2. Log logout event to auth_logs table
3. Return success (token clearing happens client-side)
4. Client removes token from localStorage
5. Client redirects to /login
```

**Session Validation (JWT Middleware Enhancement):**

```typescript
async function validateJWT(token: string) {
  // 1. Verify JWT signature
  const decoded = jwt.verify(token, JWT_SECRET);

  // 2. Check expiration
  if (decoded.exp < Date.now() / 1000) {
    throw new UnauthorizedError('Token expired');
  }

  // 3. Fetch user from database
  const user = await User.findById(decoded.user_id);

  // 4. Check user exists
  if (!user) {
    throw new UnauthorizedError('User not found');
  }

  // 5. Check user is active
  if (user.account_status !== 'active') {
    throw new ForbiddenError('Account deactivated');
  }

  // 6. Check account not locked
  if (user.locked_until && user.locked_until > new Date()) {
    throw new ForbiddenError('Account locked');
  }

  // 7. Optional: Check subscription tier changed
  // (can refresh token if tier changed, or just use current token value)

  return user;
}
```

**Session Lifecycle States:**

1. **Active**: Token valid, user active, not locked
2. **Expired**: Token past expiration timestamp
3. **Revoked**: User deactivated or locked
4. **Invalid**: Bad signature or malformed token

**Edge Cases to Handle:**

- Token valid but user deleted → 401 "User not found"
- Token valid but account deactivated → 403 "Account deactivated"
- Token valid but account locked → 403 "Account locked. Try again after {time}"
- Token expired → 401 "Session expired. Please login again"
- Token signature invalid → 401 "Invalid token"
- No token provided → 401 "Authentication required"

**Files to Create/Modify:**

- `routes/auth.ts` - Add logout endpoint
- `controllers/auth.controller.ts` - Logout handler
- `middleware/jwt.ts` - Enhanced session validation
- `services/session.service.ts` - Session management logic
- `utils/jwt.utils.ts` - JWT helper functions

**Frontend Integration Notes:**

- Token stored in localStorage for persistence
- Token sent in Authorization header: `Bearer <token>`
- On 401/403 response: clear token, redirect to login
- On logout: clear token, redirect to login
- "Remember me" checkbox on login form

## Dependencies

- [ ] Task 003 completed (login endpoints working)
- [ ] JWT middleware from Task 003

## Effort Estimate

- Size: S
- Hours: 6-8 hours
- Parallel: true (can work alongside other tasks)

## Definition of Done

- [ ] Logout endpoint implemented and tested
- [ ] "Remember me" functionality working (30-day tokens)
- [ ] Default token expiration working (3-day tokens)
- [ ] Session validation handles all edge cases
- [ ] Token expiration tested
- [ ] Deactivated user validation tested
- [ ] Locked account validation tested
- [ ] Logout event logged to auth_logs
- [ ] Frontend integration tested (token storage/clearing)
- [ ] Unit tests for session validation logic
- [ ] Integration tests for logout flow
- [ ] Code reviewed and merged
