---
name: Trial Period and Subscription Integration
status: open
created: 2026-01-06T08:26:55Z
updated: 2026-01-06T08:26:55Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: true
conflicts_with: []
---

# Task: Trial Period and Subscription Integration

## Description

Implement trial period tracking (14 days from email verification), subscription tier checking during login, automatic downgrade to free tier on expiration, and account deactivation logic. Integrate with subscription system for feature access control.

## Acceptance Criteria

- [ ] Trial period starts on email verification (14 days)
- [ ] Trial expiration date stored in `trial_expires_at` field
- [ ] Login checks trial expiration and downgrades if needed
- [ ] Subscription tier stored in JWT token for authorization
- [ ] Deactivated accounts cannot login
- [ ] Subscription tier changes require re-login (or token refresh)
- [ ] Trial status visible in user profile
- [ ] Admin can manually activate/deactivate accounts
- [ ] Account deactivation endpoint implemented

## Technical Details

**Trial Period Logic:**

1. **On Email Verification:**
```typescript
async function verifyEmail(token: string) {
  const verification = await EmailVerification.findOne({ token });

  if (!verification || verification.verified) {
    throw new Error('Invalid or already used token');
  }

  if (verification.expires_at < new Date()) {
    throw new Error('Token expired');
  }

  await User.update(verification.user_id, {
    email_verified: true,
    email_verified_at: new Date(),
    account_status: 'active',
    subscription_tier: 'trial',
    trial_expires_at: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000) // 14 days
  });

  await verification.update({ verified: true });
}
```

2. **On Login - Check Trial Expiration:**
```typescript
async function login(email: string, password: string) {
  const user = await User.findByEmail(email);

  // ... password verification ...

  // Check trial expiration
  if (user.subscription_tier === 'trial' &&
      user.trial_expires_at &&
      user.trial_expires_at < new Date()) {

    // Downgrade to free tier
    await user.update({
      subscription_tier: 'free'
    });

    user.subscription_tier = 'free'; // Update in-memory for JWT
  }

  // Generate JWT with current subscription tier
  const token = generateJWT({
    user_id: user.id,
    email: user.email,
    subscription_tier: user.subscription_tier
  });

  return { token, user };
}
```

**Subscription Tiers:**
- `trial`: Full access for 14 days from email verification
- `free`: Limited features (define based on product requirements)
- `pro`: Full features (paid subscription)
- `enterprise`: Advanced features (paid subscription)

**Account Deactivation:**

```typescript
// Admin endpoint: PUT /api/admin/users/:userId/deactivate
async function deactivateAccount(userId: string) {
  await User.update(userId, {
    account_status: 'deactivated'
  });

  // Invalidate all sessions (future enhancement: maintain session blacklist)
  // For now: user will be blocked on next request due to status check in JWT middleware
}

// Admin endpoint: PUT /api/admin/users/:userId/activate
async function activateAccount(userId: string) {
  await User.update(userId, {
    account_status: 'active'
  });
}
```

**JWT Middleware Enhancement:**
```typescript
async function validateJWT(token: string) {
  const decoded = jwt.verify(token, JWT_SECRET);
  const user = await User.findById(decoded.user_id);

  if (!user || user.account_status !== 'active') {
    throw new ForbiddenError('Account deactivated');
  }

  // Optional: Check if subscription tier in token matches current tier
  // If different, could force token refresh
  if (decoded.subscription_tier !== user.subscription_tier) {
    // Log discrepancy, optionally force re-login
    console.warn(`Token tier mismatch for user ${user.id}`);
  }

  return user;
}
```

**Feature Access Control (Future Use):**
```typescript
// Middleware for feature-based access
function requireSubscription(tier: string | string[]) {
  return (req, res, next) => {
    const userTier = req.user.subscription_tier;
    const allowedTiers = Array.isArray(tier) ? tier : [tier];

    if (!allowedTiers.includes(userTier)) {
      return res.status(403).json({
        error: 'Subscription upgrade required',
        current_tier: userTier,
        required_tier: tier
      });
    }

    next();
  };
}

// Usage:
app.get('/api/advanced-feature',
  authenticateJWT,
  requireSubscription(['pro', 'enterprise']),
  handleAdvancedFeature
);
```

**User Profile Endpoint Enhancement:**
```typescript
GET /api/auth/me

Response:
{
  user: {
    id: "uuid",
    email: "user@example.com",
    full_name: "John Doe",
    subscription_tier: "trial",
    trial_expires_at: "2026-01-20T08:26:55Z",  // or null if not on trial
    trial_days_remaining: 14,  // calculated
    account_status: "active"
  }
}
```

**Admin Endpoints to Create:**
```typescript
PUT /api/admin/users/:userId/deactivate
PUT /api/admin/users/:userId/activate
GET /api/admin/users/:userId/subscription
PUT /api/admin/users/:userId/subscription
```

**Files to Create/Modify:**
- `services/subscription.service.ts` - Trial and subscription logic
- `controllers/admin.controller.ts` - Admin user management
- `routes/admin.ts` - Admin routes
- `middleware/subscription.ts` - Subscription-based access control
- `controllers/auth.controller.ts` - Add trial logic to login/verification

**Database Updates:**
- No schema changes needed (fields already in users table from Task 001)

**Testing Scenarios:**
1. New user registers → email verified → trial period set to 14 days
2. User logs in during trial → subscription_tier='trial' in JWT
3. User logs in after trial expired → subscription downgraded to 'free'
4. Admin deactivates account → user cannot login
5. Admin activates account → user can login again
6. Subscription tier changes → reflected on next login

## Dependencies

- [ ] Task 001 completed (database schema with subscription fields)
- [ ] Task 003 completed (login/verification endpoints)
- [ ] Subscription system design (subscription tiers defined)

## Effort Estimate

- Size: M
- Hours: 8-10 hours
- Parallel: true (can work alongside frontend tasks)

## Definition of Done

- [ ] Trial period logic implemented in email verification
- [ ] Trial expiration check on login
- [ ] Automatic downgrade to free tier working
- [ ] Subscription tier in JWT token
- [ ] Account deactivation endpoint working
- [ ] Account activation endpoint working
- [ ] JWT middleware checks account status
- [ ] User profile shows trial status
- [ ] Trial days remaining calculated correctly
- [ ] All subscription scenarios tested
- [ ] Admin endpoints secured (admin auth required)
- [ ] Unit tests for trial logic
- [ ] Integration tests for subscription flows
- [ ] Documentation updated
- [ ] Code reviewed and merged
