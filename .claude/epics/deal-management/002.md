---
name: Deal Service and API Endpoints
status: open
created: 2026-01-24T14:08:03Z
updated: 2026-01-24T14:08:03Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: false
---

# Task: Deal Service and API Endpoints

## Description

Implement the Supabase client service layer and API routes for deal CRUD operations, stage changes with milestone auto-creation, activity logging, and commission calculations.

## Checklist

- [ ] Create TypeScript types in types/deals.ts
- [ ] Implement lib/deals.ts service functions (getDealTypes, getPipelineDeals, createDeal, changeDealStage)
- [ ] Create POST /api/deals endpoint with validation
- [ ] Create PATCH /api/deals/:id/stage endpoint with milestone triggers
- [ ] Create GET /api/deals/pipeline endpoint with stage grouping
- [ ] Create POST /api/deals/:id/activities endpoint
- [ ] Implement commission auto-calculation logic
- [ ] Add activity logging for all deal changes
- [ ] Tests written (TDD: service functions, API routes)
- [ ] All tests passing
- [ ] Code reviewed

## Reference

See epic.md sections:
- "TypeScript Types" for all type definitions (lines 735-898)
- "API Endpoints" for request/response formats (lines 583-731)
- "Service Integration" for Supabase client code (lines 970-1207)

## Dependencies

- Task 001 must complete first (database tables required)

## Effort: Large (12 hours)
