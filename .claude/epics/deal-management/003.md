---
name: Supabase Storage Setup for Documents
status: open
created: 2026-01-24T14:08:03Z
updated: 2026-01-24T14:08:03Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: true
---

# Task: Supabase Storage Setup for Documents

## Description

Configure Supabase Storage bucket for deal documents with RLS policies for secure upload, view, and delete operations scoped to deal ownership.

## Step-by-Step Instructions

### 1. Create Storage Bucket
1. Go to Supabase Dashboard -> Storage
2. Click "New bucket"
3. Configure:
   - Name: `deal-documents`
   - Public bucket: **No** (keep private)
   - File size limit: 25MB
   - Allowed MIME types: `application/pdf,image/jpeg,image/png,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`

### 2. Create RLS Policies
Run the storage RLS policies from epic.md in Supabase SQL Editor:
- Policy for INSERT: Users can upload to their assigned deals
- Policy for SELECT: Users can view documents from their deals
- Policy for DELETE: Users can delete documents from their deals

### 3. Implement Document Upload Service
1. Add uploadDealDocument function to lib/deals.ts
2. Create POST /api/deals/:id/documents endpoint
3. Handle file validation (size, type)
4. Generate signed download URLs

### 4. Test Upload Flow
1. Create a test deal
2. Upload a test PDF file
3. Verify file appears in Storage bucket
4. Verify download URL works

## Checklist

- [ ] Storage bucket created in Supabase Dashboard
- [ ] RLS policies applied for upload/view/delete
- [ ] Document upload service function implemented
- [ ] POST /api/deals/:id/documents endpoint created
- [ ] File validation (25MB, allowed types) working
- [ ] Signed URL generation for downloads
- [ ] Integration tested with authenticated user
- [ ] Tests written
- [ ] All tests passing

## Reference

See epic.md sections:
- "Third-Party Setup > Supabase Storage Configuration" (lines 1209-1273)
- "Service Integration > uploadDealDocument" (lines 1159-1206)

## Dependencies

- Task 001 must complete first (deals table required for RLS)

## Effort: Medium (6 hours)
