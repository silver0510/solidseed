---
name: Supabase Storage Setup
status: closed
created: 2026-01-12T04:48:34Z
updated: 2026-01-13T04:10:08Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: false
---

# Task: Supabase Storage Setup

## Description

Configure Supabase Storage bucket for client documents with proper RLS policies for secure file access.

## Step-by-Step Instructions

### 1. Create Storage Bucket

1. Go to Supabase Dashboard → Storage
2. Click "New bucket"
3. Configure bucket settings:
   - Name: `client-documents`
   - Public bucket: OFF (unchecked)
   - File size limit: 10MB (10485760 bytes)
   - Allowed MIME types: `application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,image/jpeg,image/png`
4. Click "Create bucket"

### 2. Configure Storage RLS Policies

1. Navigate to Storage → Policies
2. Select `client-documents` bucket
3. Add three policies using SQL Editor:

**Insert Policy (Upload)**:
```sql
CREATE POLICY "Users can upload documents for their clients"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'client-documents' AND
  EXISTS (
    SELECT 1 FROM clients
    WHERE clients.id = (storage.foldername(name))[1]
    AND clients.assigned_to = auth.uid()::text
    AND clients.is_deleted = FALSE
  )
);
```

**Select Policy (Read)**:
```sql
CREATE POLICY "Users can read documents for their clients"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'client-documents' AND
  EXISTS (
    SELECT 1 FROM clients
    WHERE clients.id = (storage.foldername(name))[1]
    AND clients.assigned_to = auth.uid()::text
    AND clients.is_deleted = FALSE
  )
);
```

**Delete Policy**:
```sql
CREATE POLICY "Users can delete documents for their clients"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'client-documents' AND
  EXISTS (
    SELECT 1 FROM clients
    WHERE clients.id = (storage.foldername(name))[1]
    AND clients.assigned_to = auth.uid()::text
  )
);
```

**Note**: The `auth.uid()::text` cast is required because `auth.uid()` returns UUID type but our `clients.assigned_to` field uses VARCHAR(255) for Better Auth CUID compatibility.

### 3. Verification

1. Create a test client in the database
2. Upload a test file using authenticated session:
```bash
curl -X POST "https://your-project.supabase.co/storage/v1/object/client-documents/{client_id}/test/test.pdf" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@test.pdf"
```
3. Verify file appears in Storage dashboard
4. Verify unauthorized users cannot access the file
5. Delete test file and client

## Checklist

- [x] Storage bucket created with correct settings
- [x] Insert RLS policy added
- [x] Select RLS policy added
- [x] Delete RLS policy added
- [x] Upload test successful with authenticated user
- [x] Unauthorized access blocked (verified)
- [x] Test cleanup completed

## Reference

- [SUPABASE-SETUP.md](../../SUPABASE-SETUP.md) - Complete Supabase setup guide
- Section: [Storage Configuration](../../SUPABASE-SETUP.md#storage-configuration)

See epic.md sections:
- "Supabase Storage Configuration" for complete policy SQL
- "Third-Party Setup > Supabase Storage Setup" for step-by-step guide

## Effort: Small (2 hours)
