---
name: configure-supabase-storage
status: open
created: 2026-01-07T02:57:01Z
updated: 2026-01-07T02:57:01Z
github: null
depends_on: [004]
parallel: true
conflicts_with: []
---

# Task: Configure Supabase Storage and test file upload

## Description

Set up Supabase Storage for client document management. Create a storage bucket with row-level security policies, implement a storage helper library, and create a test endpoint to verify file upload functionality.

## Acceptance Criteria

- [ ] Storage bucket "client-documents" created in Supabase
- [ ] Row-level security policies configured for authenticated users
- [ ] Storage helper library created at `lib/storage.ts`
- [ ] Test endpoint created at `app/api/test/storage/route.ts`
- [ ] File upload tested successfully with multipart/form-data
- [ ] File download URL generation working
- [ ] File deletion functionality implemented
- [ ] Storage configuration documented in README

## Technical Details

### Implementation Steps

**1. Create Storage Bucket in Supabase**

```sql
-- Run in Supabase SQL Editor
insert into storage.buckets (id, name, public)
values ('client-documents', 'client-documents', false);

-- Enable RLS
alter table storage.objects enable row level security;

-- Policy: Users can upload their own files
create policy "Users can upload files"
on storage.objects for insert
to authenticated
with check (
  bucket_id = 'client-documents' and
  auth.uid()::text = (storage.foldername(name))[1]
);

-- Policy: Users can read their own files
create policy "Users can read own files"
on storage.objects for select
to authenticated
using (
  bucket_id = 'client-documents' and
  auth.uid()::text = (storage.foldername(name))[1]
);

-- Policy: Users can delete their own files
create policy "Users can delete own files"
on storage.objects for delete
to authenticated
using (
  bucket_id = 'client-documents' and
  auth.uid()::text = (storage.foldername(name))[1]
);
```

**2. Create Storage Helper Library**

```typescript
// lib/storage.ts
import { createClient } from '@/lib/supabase/server';

export interface UploadFileOptions {
  userId: string;
  file: File;
  folder?: string;
}

export interface UploadFileResult {
  path: string;
  url: string;
}

export class StorageService {
  private static BUCKET = 'client-documents';

  static async uploadFile({
    userId,
    file,
    folder = 'documents',
  }: UploadFileOptions): Promise<UploadFileResult> {
    const supabase = createClient();

    // Generate unique filename
    const timestamp = Date.now();
    const fileName = `${timestamp}-${file.name}`;
    const filePath = `${userId}/${folder}/${fileName}`;

    // Upload file
    const { data, error } = await supabase.storage.from(this.BUCKET).upload(filePath, file, {
      cacheControl: '3600',
      upsert: false,
    });

    if (error) {
      throw new Error(`Upload failed: ${error.message}`);
    }

    // Get public URL
    const {
      data: { publicUrl },
    } = supabase.storage.from(this.BUCKET).getPublicUrl(data.path);

    return {
      path: data.path,
      url: publicUrl,
    };
  }

  static async deleteFile(filePath: string): Promise<void> {
    const supabase = createClient();

    const { error } = await supabase.storage.from(this.BUCKET).remove([filePath]);

    if (error) {
      throw new Error(`Delete failed: ${error.message}`);
    }
  }

  static async getSignedUrl(filePath: string, expiresIn: number = 3600): Promise<string> {
    const supabase = createClient();

    const { data, error } = await supabase.storage
      .from(this.BUCKET)
      .createSignedUrl(filePath, expiresIn);

    if (error) {
      throw new Error(`Failed to generate signed URL: ${error.message}`);
    }

    return data.signedUrl;
  }

  static async listFiles(userId: string, folder?: string): Promise<string[]> {
    const supabase = createClient();
    const path = folder ? `${userId}/${folder}` : userId;

    const { data, error } = await supabase.storage.from(this.BUCKET).list(path);

    if (error) {
      throw new Error(`List failed: ${error.message}`);
    }

    return data.map((file) => file.name);
  }
}
```

**3. Create Test Endpoint**

```typescript
// app/api/test/storage/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { StorageService } from '@/lib/storage';
import { createClient } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
  try {
    // Get authenticated user
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Parse multipart form data
    const formData = await request.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return NextResponse.json({ error: 'No file provided' }, { status: 400 });
    }

    // Upload file
    const result = await StorageService.uploadFile({
      userId: user.id,
      file,
      folder: 'test-uploads',
    });

    // Generate signed URL
    const signedUrl = await StorageService.getSignedUrl(result.path);

    return NextResponse.json({
      success: true,
      data: {
        path: result.path,
        publicUrl: result.url,
        signedUrl,
        fileName: file.name,
        fileSize: file.size,
        fileType: file.type,
      },
    });
  } catch (error) {
    console.error('Storage test error:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Upload failed' },
      { status: 500 }
    );
  }
}

export async function DELETE(request: NextRequest) {
  try {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { filePath } = await request.json();

    if (!filePath) {
      return NextResponse.json({ error: 'No file path provided' }, { status: 400 });
    }

    await StorageService.deleteFile(filePath);

    return NextResponse.json({
      success: true,
      message: 'File deleted successfully',
    });
  } catch (error) {
    console.error('Storage delete error:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Delete failed' },
      { status: 500 }
    );
  }
}

export async function GET(request: NextRequest) {
  try {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const files = await StorageService.listFiles(user.id, 'test-uploads');

    return NextResponse.json({
      success: true,
      data: { files },
    });
  } catch (error) {
    console.error('Storage list error:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'List failed' },
      { status: 500 }
    );
  }
}
```

### Key Files Created/Modified

- `lib/storage.ts` - Storage service helper
- `app/api/test/storage/route.ts` - Test endpoint for upload/delete/list
- Supabase storage bucket configuration (via SQL)
- README.md - Storage setup documentation

## Dependencies

### Depends On

- Task 004: Supabase client libraries must be configured

### Blocks

- Task 009: Environment validation needs storage configuration

## Effort Estimate

- **Size**: M
- **Hours**: 2-3 hours
- **Parallel**: true (can work alongside OAuth and email setup)

## Definition of Done

- [x] Storage bucket created with RLS policies
- [x] Storage helper library with upload/delete/list/signed URL methods
- [x] Test endpoint returns successful upload response
- [x] File download URL accessible
- [x] File deletion working
- [x] Storage limits and policies documented

## Validation Commands

```bash
# Test file upload (requires authentication token)
curl -X POST http://localhost:3000/api/test/storage \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test-document.pdf"

# Expected response:
# {
#   "success": true,
#   "data": {
#     "path": "user-id/test-uploads/1234567890-test-document.pdf",
#     "publicUrl": "https://...supabase.co/storage/v1/object/public/...",
#     "signedUrl": "https://...supabase.co/storage/v1/object/sign/...",
#     "fileName": "test-document.pdf",
#     "fileSize": 12345,
#     "fileType": "application/pdf"
#   }
# }

# Test file listing
curl http://localhost:3000/api/test/storage \
  -H "Authorization: Bearer YOUR_TOKEN"

# Test file deletion
curl -X DELETE http://localhost:3000/api/test/storage \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"filePath":"user-id/test-uploads/1234567890-test-document.pdf"}'

# Check Supabase Storage in dashboard
# https://app.supabase.com/project/YOUR_PROJECT/storage/buckets
```

## Troubleshooting

**Issue: "new row violates row-level security policy"**

- Ensure RLS policies are created correctly
- Verify user is authenticated
- Check that file path starts with user ID

**Issue: "Bucket not found"**

- Create bucket in Supabase dashboard or via SQL
- Verify bucket name matches "client-documents"

**Issue: "File too large"**

- Default Supabase limit is 50MB
- Increase in project settings if needed
- Add client-side validation for file size

**Issue: "CORS error when accessing signed URL"**

- Configure CORS in Supabase storage settings
- Add allowed origins for your domain

## Next Steps

After completing this task:

1. Integrate storage service into client documents feature
2. Add file type validation (PDF, DOCX, images only)
3. Implement file scanning/virus checking if needed
4. Set up automated cleanup for old test files
5. Configure CDN caching for frequently accessed files
