---
name: Create Supabase project and configure database connection
status: open
created: 2026-01-07T02:57:01Z
updated: 2026-01-07T02:57:01Z
github: null
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: Create Supabase Project and Configure Database Connection

## Description

Set up a Supabase project for Korella CRM including PostgreSQL database provisioning, CLI installation, and connection configuration. This establishes the data layer foundation with proper authentication and connection pooling.

## Acceptance Criteria

- [ ] Supabase account created (free tier)
- [ ] New Supabase project created: "korella-crm"
- [ ] Supabase CLI installed globally
- [ ] Local Supabase configuration initialized
- [ ] Remote project linked to local development
- [ ] Database connection credentials obtained
- [ ] Environment variables configured in `.env.local`
- [ ] Supabase client library initialized in `lib/db.ts`
- [ ] Test database connection successful
- [ ] Connection pooling verified in Supabase dashboard
- [ ] Database accessible via Supabase Studio

## Technical Details

### Implementation Steps

**1. Create Supabase Account**

Visit https://app.supabase.com and create account:
- Sign up with GitHub (recommended) or email
- Verify email address
- Complete onboarding wizard

**2. Create New Supabase Project**

In Supabase Dashboard:
1. Click "New Project"
2. Select organization (or create one)
3. **Project name**: `korella-crm`
4. **Database password**: Generate strong password (save securely!)
5. **Region**: Select closest to your location (e.g., `us-east-1`)
6. **Pricing plan**: Free tier
7. Click "Create new project"

⏱️ **Wait 1-2 minutes** for project provisioning

**3. Get Project Credentials**

From project settings page:

Navigate to **Settings** → **API**:
- Copy **Project URL**: `https://[project-ref].supabase.co`
- Copy **anon public key**: `eyJ...`

Navigate to **Settings** → **Database**:
- Copy **Connection string** → **URI**: `postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres`
- Note the **Project ref**: `[project-ref]`

**4. Install Supabase CLI**

```bash
# Install globally via npm
npm install -g supabase

# Verify installation
supabase --version
# Should show: supabase 1.x.x
```

**5. Initialize Supabase Locally**

```bash
# Navigate to project root
cd /path/to/korella-crm

# Initialize Supabase
supabase init

# This creates:
# - supabase/config.toml
# - .gitignore entries
```

**6. Link to Remote Project**

```bash
# Login to Supabase CLI
supabase login

# This opens browser for OAuth login
# Authorize Supabase CLI

# Link to remote project
supabase link --project-ref [your-project-ref]

# Enter database password when prompted
```

**7. Create Environment Variables File**

Create `.env.local` at project root:

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://[project-ref].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...your-anon-key...
SUPABASE_DATABASE_URL=postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres

# Better Auth (will be used in User Auth epic)
BETTER_AUTH_SECRET=
BETTER_AUTH_URL=http://localhost:3000

# OAuth - Google (will be configured in Task 006)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

# Email (will be configured in Task 007)
RESEND_API_KEY=

# Monitoring (will be configured in Task 007)
NEXT_PUBLIC_SENTRY_DSN=
```

**Note**: Only Supabase variables have values for now. Others are placeholders for later tasks.

**8. Create .env.example Template**

Create `.env.example`:

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_DATABASE_URL=postgresql://postgres:password@db.your-project.supabase.co:5432/postgres

# Better Auth
BETTER_AUTH_SECRET=your-32-char-secret
BETTER_AUTH_URL=http://localhost:3000

# OAuth - Google
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret

# Email
RESEND_API_KEY=re_your-api-key

# Monitoring
NEXT_PUBLIC_SENTRY_DSN=https://key@org.ingest.sentry.io/project
```

**9. Create Supabase Client Library**

Create `lib/db.ts`:

```typescript
import { createClient } from '@supabase/supabase-js';

// Validate environment variables
if (!process.env.NEXT_PUBLIC_SUPABASE_URL) {
  throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL environment variable');
}

if (!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
  throw new Error('Missing NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable');
}

// Create Supabase client
export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
    },
    db: {
      schema: 'public',
    },
    global: {
      headers: {
        'x-application-name': 'korella-crm',
      },
    },
  }
);

// Export types for TypeScript
export type SupabaseClient = typeof supabase;
```

**10. Create Database Test Utility**

Create `app/api/test/database/route.ts`:

```typescript
import { NextResponse } from 'next/server';
import { supabase } from '@/lib/db';

export async function GET() {
  try {
    // Test database connection by querying system tables
    const { data, error } = await supabase
      .from('pg_catalog.pg_tables')
      .select('tablename')
      .eq('schemaname', 'public')
      .limit(1);

    if (error) {
      return NextResponse.json(
        { success: false, error: error.message },
        { status: 500 }
      );
    }

    return NextResponse.json({
      success: true,
      message: 'Database connection successful',
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}
```

**11. Test Database Connection**

```bash
# Start development server
npm run dev

# Test database connection via API
curl http://localhost:3000/api/test/database

# Expected response:
# {"success":true,"message":"Database connection successful","timestamp":"2026-01-07T..."}
```

**12. Verify in Supabase Dashboard**

1. Go to https://app.supabase.com
2. Select your project
3. Navigate to **Table Editor**
4. Should see empty database (no tables yet - they'll be created in User Auth epic)
5. Navigate to **Database** → **Pooler**
6. Verify **Connection pooling** is active

### Configuration Files Created

- `.env.local` - Environment variables (gitignored)
- `.env.example` - Template (committed to git)
- `lib/db.ts` - Supabase client initialization
- `app/api/test/database/route.ts` - Database connection test
- `supabase/config.toml` - Supabase CLI configuration

### Supabase Dashboard Navigation

**Key Sections**:
- **Table Editor**: View and edit database tables
- **SQL Editor**: Run SQL queries
- **Database**: Schema, extensions, connection strings
- **Storage**: File storage (configured in Task 005)
- **Authentication**: User management (configured in User Auth epic)

## Dependencies

### Depends On
- **Task 001**: Next.js project must exist

### Blocks
- **Task 005**: Storage configuration
- **User Authentication Epic**: Needs database for user tables

### Can Run in Parallel With
- **Task 006**: Google OAuth setup (independent)
- **Task 007**: Resend and Sentry setup (independent)

## Effort Estimate

- **Size**: Medium (M)
- **Hours**: 1-2 hours (including account setup and waiting)
- **Parallel**: Yes (can run alongside Task 006, 007)

## Definition of Done

- [x] Supabase account created and verified
- [x] Project "korella-crm" provisioned successfully
- [x] Supabase CLI installed and logged in
- [x] Local project linked to remote
- [x] `.env.local` created with Supabase credentials
- [x] `.env.example` template created
- [x] `lib/db.ts` created and imports successfully
- [x] Test endpoint returns success
- [x] Can access Supabase Studio web UI
- [x] Connection pooling active in dashboard
- [x] No compilation errors when importing `lib/db.ts`

## Validation Commands

```bash
# Verify Supabase CLI installation
supabase --version

# Check CLI login status
supabase projects list

# Test database connection via API
curl http://localhost:3000/api/test/database

# Verify environment variables loaded
node -e "console.log(process.env.NEXT_PUBLIC_SUPABASE_URL)"
# Should print your Supabase URL (run with dotenv if needed)

# Check TypeScript compilation
npx tsc --noEmit
```

## Troubleshooting

**Issue**: Supabase project provisioning taking too long

**Solution**:
- Wait up to 5 minutes
- Check Supabase status page: https://status.supabase.com
- Try different region if issues persist

**Issue**: CLI login fails

**Solution**:
```bash
# Logout and re-login
supabase logout
supabase login

# Or use access token directly
supabase login --access-token [your-token]
```

**Issue**: Database connection test fails

**Solution**:
- Verify `.env.local` has correct credentials
- Check no typos in environment variable names
- Ensure development server restarted after adding `.env.local`
- Verify anon key matches exactly (no extra spaces)

**Issue**: "Missing environment variable" error

**Solution**:
```bash
# Restart dev server to load .env.local
npm run dev
```

**Issue**: Cannot link to remote project

**Solution**:
- Verify project ref is correct (check Supabase dashboard URL)
- Ensure database password is correct
- Check internet connection

## Security Notes

⚠️ **Important**:
- Never commit `.env.local` to git
- Database password should be strong (20+ characters)
- `anon` key is public (can be exposed to frontend)
- Never expose `service_role` key (not used in this task)

## Next Steps

After completing this task:
1. Mark task as complete
2. Proceed to Task 005 (Supabase Storage configuration)
3. Database ready for migrations in User Authentication epic
4. Keep Supabase dashboard credentials secure
