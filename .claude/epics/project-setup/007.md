---
name: configure-resend-sentry
status: open
created: 2026-01-07T02:57:01Z
updated: 2026-01-07T02:57:01Z
github: null
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: Configure Resend email service and Sentry monitoring

## Description

Set up Resend for transactional email delivery and Sentry for error monitoring and performance tracking. Configure API keys, install necessary packages, create email helper library, and set up test endpoints to verify both services are working correctly.

## Acceptance Criteria

- [ ] Resend account created with API key
- [ ] Sentry project created with DSN
- [ ] `@sentry/nextjs` package installed and configured
- [ ] `resend` package installed
- [ ] Email helper library created at `lib/email.ts`
- [ ] Test endpoint created at `app/api/test/email/route.ts`
- [ ] Sentry instrumentation file created
- [ ] Test email sent successfully
- [ ] Sentry error tracking verified
- [ ] Configuration documented in README

## Technical Details

### Implementation Steps

**1. Set Up Resend Account**

```bash
# 1. Go to https://resend.com/signup
# 2. Sign up with email
# 3. Verify email address
# 4. Go to API Keys section
# 5. Create new API key: "Korella CRM - Development"
# 6. Copy API key (starts with re_)

# 7. Add domain for production (optional for dev)
#    - Go to Domains
#    - Add domain: korella.app
#    - Add DNS records (MX, TXT, CNAME)
#    - Verify domain

# For development, use onboarding@resend.dev as from address
```

**2. Set Up Sentry Account**

```bash
# 1. Go to https://sentry.io/signup
# 2. Sign up or log in
# 3. Create new project
#    - Platform: Next.js
#    - Project name: korella-crm
# 4. Copy DSN (looks like https://xxx@xxx.ingest.sentry.io/xxx)
# 5. Skip wizard (we'll configure manually)
```

**3. Install Packages**

```bash
npm install resend @sentry/nextjs

# Resend version should be ^3.0.0
# Sentry version should be ^8.0.0
```

**4. Configure Sentry**

```bash
# Run Sentry wizard (optional, or configure manually)
npx @sentry/wizard@latest -i nextjs

# Or create files manually:
```

```typescript
// instrumentation.ts (root of project)
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./sentry.server.config');
  }

  if (process.env.NEXT_RUNTIME === 'edge') {
    await import('./sentry.edge.config');
  }
}

export const onRequestError = async (err: Error, request: Request, context: any) => {
  await import('./sentry.server.config');
  const Sentry = await import('@sentry/nextjs');
  Sentry.captureException(err, {
    contexts: {
      request: {
        url: request.url,
        method: request.method,
        headers: Object.fromEntries(request.headers.entries()),
      },
    },
  });
};
```

```typescript
// sentry.server.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,

  // Adjust sample rate for production
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,

  // Capture 100% of errors
  sampleRate: 1.0,

  // Environment
  environment: process.env.NODE_ENV || 'development',

  // Release tracking
  release: process.env.VERCEL_GIT_COMMIT_SHA,

  // Only send errors in production
  enabled: process.env.NODE_ENV === 'production',

  // Integrations
  integrations: [Sentry.prismaIntegration(), Sentry.postgresIntegration()],

  // Filter out sensitive data
  beforeSend(event, hint) {
    // Remove sensitive headers
    if (event.request?.headers) {
      delete event.request.headers['authorization'];
      delete event.request.headers['cookie'];
    }
    return event;
  },
});
```

```typescript
// sentry.edge.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  environment: process.env.NODE_ENV || 'development',
  enabled: process.env.NODE_ENV === 'production',
});
```

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,

  environment: process.env.NODE_ENV || 'development',

  enabled: process.env.NODE_ENV === 'production',

  // Replay for debugging
  replaysOnErrorSampleRate: 1.0,
  replaysSessionSampleRate: 0.1,

  integrations: [
    Sentry.replayIntegration({
      maskAllText: true,
      blockAllMedia: true,
    }),
  ],
});
```

**5. Add Environment Variables**

```bash
# Add to .env.local
cat >> .env.local << 'EOF'

# Resend Email Service
RESEND_API_KEY=re_your_api_key_here

# Sentry Error Monitoring
SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
NEXT_PUBLIC_SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
SENTRY_AUTH_TOKEN=your_auth_token_here
EOF

# Add to .env.example
cat >> .env.example << 'EOF'

# Resend Email Service (Get from resend.com)
RESEND_API_KEY=re_your_api_key

# Sentry Error Monitoring (Get from sentry.io)
SENTRY_DSN=your_sentry_dsn
NEXT_PUBLIC_SENTRY_DSN=your_sentry_dsn
SENTRY_AUTH_TOKEN=your_sentry_auth_token
EOF
```

**6. Create Email Helper Library**

```typescript
// lib/email.ts
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export interface SendEmailOptions {
  to: string | string[];
  subject: string;
  html: string;
  text?: string;
  from?: string;
  replyTo?: string;
}

export interface SendEmailResult {
  id: string;
  success: boolean;
}

export class EmailService {
  private static FROM_EMAIL = process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev';
  private static FROM_NAME = 'Korella CRM';

  static async sendEmail({
    to,
    subject,
    html,
    text,
    from,
    replyTo,
  }: SendEmailOptions): Promise<SendEmailResult> {
    try {
      const { data, error } = await resend.emails.send({
        from: from || `${this.FROM_NAME} <${this.FROM_EMAIL}>`,
        to: Array.isArray(to) ? to : [to],
        subject,
        html,
        text,
        replyTo,
      });

      if (error) {
        console.error('Email send error:', error);
        throw new Error(`Failed to send email: ${error.message}`);
      }

      return {
        id: data!.id,
        success: true,
      };
    } catch (error) {
      console.error('Email service error:', error);
      throw error;
    }
  }

  static async sendVerificationEmail(
    email: string,
    verificationUrl: string
  ): Promise<SendEmailResult> {
    const html = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .button { display: inline-block; padding: 12px 24px; background: #0070f3; color: white; text-decoration: none; border-radius: 5px; }
            .footer { margin-top: 30px; font-size: 12px; color: #666; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>Verify your email address</h1>
            <p>Thank you for signing up for Korella CRM! Please verify your email address by clicking the button below:</p>
            <p>
              <a href="${verificationUrl}" class="button">Verify Email Address</a>
            </p>
            <p>Or copy and paste this link into your browser:</p>
            <p>${verificationUrl}</p>
            <div class="footer">
              <p>If you didn't create an account, you can safely ignore this email.</p>
              <p>This link will expire in 24 hours.</p>
            </div>
          </div>
        </body>
      </html>
    `;

    return this.sendEmail({
      to: email,
      subject: 'Verify your email address - Korella CRM',
      html,
      text: `Verify your email address by visiting: ${verificationUrl}`,
    });
  }

  static async sendPasswordResetEmail(email: string, resetUrl: string): Promise<SendEmailResult> {
    const html = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .button { display: inline-block; padding: 12px 24px; background: #0070f3; color: white; text-decoration: none; border-radius: 5px; }
            .footer { margin-top: 30px; font-size: 12px; color: #666; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>Reset your password</h1>
            <p>We received a request to reset your password. Click the button below to create a new password:</p>
            <p>
              <a href="${resetUrl}" class="button">Reset Password</a>
            </p>
            <p>Or copy and paste this link into your browser:</p>
            <p>${resetUrl}</p>
            <div class="footer">
              <p>If you didn't request a password reset, you can safely ignore this email.</p>
              <p>This link will expire in 1 hour.</p>
            </div>
          </div>
        </body>
      </html>
    `;

    return this.sendEmail({
      to: email,
      subject: 'Reset your password - Korella CRM',
      html,
      text: `Reset your password by visiting: ${resetUrl}`,
    });
  }
}
```

**7. Create Test Endpoint**

```typescript
// app/api/test/email/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { EmailService } from '@/lib/email';
import * as Sentry from '@sentry/nextjs';

export async function POST(request: NextRequest) {
  try {
    const { to, type } = await request.json();

    if (!to) {
      return NextResponse.json({ error: 'Email address required' }, { status: 400 });
    }

    let result;

    if (type === 'verification') {
      result = await EmailService.sendVerificationEmail(
        to,
        'http://localhost:3000/auth/verify?token=test123'
      );
    } else if (type === 'password-reset') {
      result = await EmailService.sendPasswordResetEmail(
        to,
        'http://localhost:3000/auth/reset?token=test456'
      );
    } else {
      result = await EmailService.sendEmail({
        to,
        subject: 'Test Email from Korella CRM',
        html: '<h1>Test Email</h1><p>This is a test email from Korella CRM.</p>',
        text: 'This is a test email from Korella CRM.',
      });
    }

    return NextResponse.json({
      success: true,
      data: result,
    });
  } catch (error) {
    console.error('Email test error:', error);
    Sentry.captureException(error);

    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to send email' },
      { status: 500 }
    );
  }
}

export async function GET() {
  try {
    // Test Sentry error tracking
    throw new Error('Test Sentry error from email endpoint');
  } catch (error) {
    Sentry.captureException(error);

    return NextResponse.json({
      success: true,
      message: 'Test error sent to Sentry',
    });
  }
}
```

**8. Update Next.js Config for Sentry**

```typescript
// next.config.js
const { withSentryConfig } = require('@sentry/nextjs');

/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    instrumentationHook: true,
  },
  // ... other config
};

module.exports = withSentryConfig(
  nextConfig,
  {
    // Sentry webpack plugin options
    silent: true,
    org: process.env.SENTRY_ORG,
    project: process.env.SENTRY_PROJECT,
  },
  {
    // Upload source maps in production only
    widenClientFileUpload: true,
    tunnelRoute: '/monitoring',
    hideSourceMaps: true,
    disableLogger: true,
  }
);
```

### Key Files Created/Modified

- `lib/email.ts` - Email service helper
- `app/api/test/email/route.ts` - Test endpoint
- `instrumentation.ts` - Sentry instrumentation
- `sentry.server.config.ts` - Server-side Sentry config
- `sentry.client.config.ts` - Client-side Sentry config
- `sentry.edge.config.ts` - Edge runtime Sentry config
- `next.config.js` - Sentry webpack plugin
- `.env.local` - API keys and DSN
- `README.md` - Setup documentation

## Dependencies

### Depends On

- Task 001: Environment setup and .env.local file must exist

### Blocks

- Task 009: Environment validation will check email and monitoring configuration

## Effort Estimate

- **Size**: M
- **Hours**: 2-2.5 hours
- **Parallel**: true (can work alongside storage and OAuth setup)

## Definition of Done

- [x] Resend API key configured
- [x] Sentry DSN configured
- [x] Packages installed
- [x] Email helper library created
- [x] Test endpoint working
- [x] Test email sent successfully
- [x] Sentry error captured
- [x] Documentation updated

## Validation Commands

```bash
# Test email sending
curl -X POST http://localhost:3000/api/test/email \
  -H "Content-Type: application/json" \
  -d '{"to":"your-email@example.com","type":"verification"}'

# Expected response:
# {
#   "success": true,
#   "data": {
#     "id": "abc123",
#     "success": true
#   }
# }

# Test Sentry error tracking
curl http://localhost:3000/api/test/email

# Expected response:
# {
#   "success": true,
#   "message": "Test error sent to Sentry"
# }

# Check Sentry dashboard for captured error
# https://sentry.io/organizations/YOUR_ORG/issues/

# Verify packages installed
npm list resend @sentry/nextjs
```

## Troubleshooting

**Issue: "Invalid API key" from Resend**

- Verify API key starts with `re_`
- Check for extra spaces or line breaks
- Create new API key if needed

**Issue: Email not received**

- Check spam folder
- Verify from address (use onboarding@resend.dev for dev)
- Check Resend dashboard for delivery status
- Verify recipient email is valid

**Issue: Sentry not capturing errors**

- Ensure `enabled: true` in config (or remove for dev)
- Check DSN is correct
- Verify instrumentation.ts is in project root
- Restart development server

**Issue: "Module not found: instrumentation"**

- Ensure Next.js version supports instrumentation (14.0.4+)
- Add `experimental.instrumentationHook: true` to next.config.js
- Restart dev server

## Next Steps

After completing this task:

1. Integrate email service with Better Auth
2. Create email templates for all transactional emails
3. Set up email preview in development (React Email)
4. Configure Sentry alerts for critical errors
5. Set up Sentry performance monitoring
6. Add custom Sentry breadcrumbs for debugging
